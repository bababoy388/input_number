<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ввод кода</title>

    <!-- ВАЖНО: Подключаем Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background-color: #292e34;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 400px;
        }

        .code-display {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 25px;
        }

        .code-input {
            width: 50px;
            height: 65px;
            border: 2px solid #333;
            border-radius: 10px;
            font-size: 28px;
            text-align: center;
            font-weight: 600;
            color: #fff;
            transition: all 0.2s;
            background-color: #292e34;
            caret-color: #3f4042;
        }

        .code-input:focus {
            outline: none;
            border-color: #007aff;
            background-color: #252525;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
        }

        .code-input.filled {
            border-color: white;
            background-color: #252525;
        }

        .input-label {
            text-align: center;
            color: #e0e0e0;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }

        .keyboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }

        .key {
            height: 70px;
            border: none;
            border-radius: 12px;
            background-color: #ffffff;
            font-size: 24px;
            font-weight: 500;
            color: #292e34;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
        }

        /* Убираем все эффекты при фокусе и наведении, оставляем только активное состояние */
        .key:focus,
        .key:hover,
        .scan-button:focus,
        .scan-button:hover,
        .backspace-button:focus,
        .backspace-button:hover {
            outline: none;
            background-color: #ffffff; /* Оригинальный цвет фона */
            color: #292e34;
        }

        /* Для специальных кнопок сохраняем оригинальный цвет текста */
        .scan-button:focus,
        .scan-button:hover {
            color: black;
        }

        /* Эффект только при нажатии (active) - кнопка становится темнее */
        .key:active,
        .scan-button:active,
        .backspace-button:active {
            background-color: #e0e0e0; /* Темнее при нажатии */
            transform: scale(0.97);
        }

        .bottom-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-top: 0;
        }

        .scan-button {
            background-color: #FFFFFF;
            color: black;
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 0.5px;
            grid-column: 1;
        }

        .zero-button {
            grid-column: 2;
        }

        .backspace-button {
            grid-column: 3;
            background-color: #ffffff;
            font-size: 20px;
        }

        .hint {
            text-align: center;
            color: #888;
            font-size: 14px;
            margin-top: 25px;
            line-height: 1.5;
        }

        .status-message {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            border-radius: 8px;
            font-weight: 500;
            display: none;
        }

        .status-success {
            background-color: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
            border: 1px solid #2ecc71;
        }

        .status-error {
            background-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }

        .status-info {
            background-color: rgba(52, 152, 219, 0.2);
            color: #3498db;
            border: 1px solid #3498db;
        }

        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }

            .key {
                height: 65px;
            }

            .code-input {
                width: 45px;
                height: 60px;
                font-size: 24px;
            }

            .scan-button {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="code-display">
            <input type="text" class="code-input" maxlength="1" inputmode="numeric" pattern="\d*">
            <input type="text" class="code-input" maxlength="1" inputmode="numeric" pattern="\d*">
            <input type="text" class="code-input" maxlength="1" inputmode="numeric" pattern="\d*">
            <input type="text" class="code-input" maxlength="1" inputmode="numeric" pattern="\d*">
            <input type="text" class="code-input" maxlength="1" inputmode="numeric" pattern="\d*">
            <input type="text" class="code-input" maxlength="1" inputmode="numeric" pattern="\d*">
        </div>

        <div class="input-label">⛶ Введите код с наклейки</div>

        <div class="keyboard">
            <button class="key" data-value="1">1</button>
            <button class="key" data-value="2">2</button>
            <button class="key" data-value="3">3</button>
            <button class="key" data-value="4">4</button>
            <button class="key" data-value="5">5</button>
            <button class="key" data-value="6">6</button>
            <button class="key" data-value="7">7</button>
            <button class="key" data-value="8">8</button>
            <button class="key" data-value="9">9</button>
        </div>

        <div class="bottom-row">
            <button class="key scan-button" id="scan-btn">Сканировать</button>
            <button class="key zero-button" data-value="0">0</button>
            <button class="key backspace-button" id="backspace-btn">⌫</button>
        </div>

        <!-- Статусные сообщения -->
        <div id="telegram-status" class="status-message status-info" style="display: none;">
            ✓ Открыто в Telegram. Код будет отправлен боту автоматически.
        </div>
        <div id="success-status" class="status-message status-success" style="display: none;">
            ✓ Код успешно отправлен!
        </div>
        <div id="error-status" class="status-message status-error" style="display: none;">
            ✗ Ошибка отправки. Откройте через Telegram бота.
        </div>
        <div id="test-status" class="status-message status-info" style="display: none;">
            ⚠️ Тестовый режим. В рабочем режиме откройте через Telegram.
        </div>
    </div>

    <script>
  document.addEventListener('DOMContentLoaded', () => {
    const codeInputs = Array.from(document.querySelectorAll('.code-input'));
    if (codeInputs.length === 0) {
      console.warn('Нет полей .code-input — скрипт завершён.');
      return;
    }

    const keyButtons = document.querySelectorAll('.key[data-value]');
    const scanButton = document.getElementById('scan-btn');
    const backspaceButton = document.getElementById('backspace-btn');

    // Статусы (могут быть null — проверяем)
    const telegramStatus = document.getElementById('telegram-status');
    const successStatus = document.getElementById('success-status');
    const errorStatus = document.getElementById('error-status');
    const testStatus = document.getElementById('test-status');

    let currentInputIndex = 0;
    let isTelegramWebApp = false;
    let isSubmitting = false;

    // ==================== УТИЛИТЫ ====================
    function clamp(n, min, max) {
      return Math.max(min, Math.min(max, n));
    }

    function setFocus(index) {
      currentInputIndex = clamp(index, 0, codeInputs.length);
      if (currentInputIndex < codeInputs.length) {
        codeInputs[currentInputIndex].focus();
      }
    }

    function getCode() {
      return codeInputs.map(i => i.value).join('');
    }

    function clearAt(index) {
      if (index >= 0 && index < codeInputs.length) {
        codeInputs[index].value = '';
        codeInputs[index].classList.remove('filled');
      }
    }

    function fillDigit(d) {
      if (!/^\d$/.test(d)) return;
      if (currentInputIndex >= codeInputs.length) return;

      const input = codeInputs[currentInputIndex];
      input.value = d;
      input.classList.add('filled');

      if (currentInputIndex < codeInputs.length - 1) {
        setFocus(currentInputIndex + 1);
      } else {
        input.blur();
        checkCode();
      }
    }

    function handleBackspace() {
      // Если все поля считались заполненными (курсор после последнего)
      if (currentInputIndex === codeInputs.length) {
        setFocus(codeInputs.length - 1);
      }

      // Если текущее поле пустое и мы не в первом — идём назад
      if (currentInputIndex > 0 && codeInputs[currentInputIndex]?.value === '') {
        setFocus(currentInputIndex - 1);
      }

      clearAt(currentInputIndex);
      setFocus(currentInputIndex); // оставить фокус на текущем индексе
    }

    function safeDisplay(el, display) {
      if (el && el.style) el.style.display = display;
    }

    function applyTgThemeBg() {
      try {
        const cssVar = getComputedStyle(document.documentElement)
          .getPropertyValue('--tg-theme-secondary-bg-color')
          .trim();
        document.body.style.backgroundColor = cssVar || '#292e34';
      } catch (_) {}
    }

    // ==================== ИНИЦИАЛИЗАЦИЯ TELEGRAM ====================
    function initTelegramIntegration() {
      console.log('Проверка окружения Telegram...');
      console.log('window.Telegram:', window.Telegram);
      console.log('window.Telegram.WebApp:', window.Telegram?.WebApp);

      try {
        const tg = window.Telegram?.WebApp;

        if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
          isTelegramWebApp = true;
          safeDisplay(telegramStatus, 'block');
          safeDisplay(testStatus, 'none');

          tg.ready();
          tg.expand();

          applyTgThemeBg();
          tg.onEvent?.('themeChanged', applyTgThemeBg);

          console.log('✅ Запущено в Telegram Web App');
          console.log('User ID:', tg.initDataUnsafe.user.id);
          console.log('Username:', tg.initDataUnsafe.user.username);
        } else {
          console.log('❌ Запущено в браузере, не в Telegram');
          safeDisplay(testStatus, 'block');
          safeDisplay(telegramStatus, 'none');
        }
      } catch (error) {
        console.warn('Ошибка инициализации Telegram:', error);
        safeDisplay(testStatus, 'block');
        safeDisplay(telegramStatus, 'none');
      }
    }

    // ==================== СТАТУСЫ ====================
    function showStatus(type, message = '') {
      [successStatus, errorStatus, telegramStatus, testStatus].forEach(el => {
        if (el) el.style.display = 'none';
      });

      if (type === 'success') {
        if (successStatus) {
          successStatus.style.display = 'block';
          if (message) successStatus.textContent = message;
          setTimeout(() => {
            if (successStatus) successStatus.style.display = 'none';
          }, 3000);
        }
      } else if (type === 'error') {
        if (errorStatus) {
          errorStatus.style.display = 'block';
          if (message) errorStatus.textContent = message;
          setTimeout(() => {
            if (errorStatus) errorStatus.style.display = 'none';
          }, 5000);
        }
      } else if (type === 'telegram') {
        safeDisplay(telegramStatus, 'block');
      }
    }

    // ==================== ОТПРАВКА В TELEGRAM ====================
    async function sendCodeToTelegram(code) {
      if (!isTelegramWebApp) {
        showStatus('error', '✗ Откройте приложение через Telegram бота');
        return false;
      }
      return sendViaTelegramWebApp(code);
    }

    async function sendViaTelegramWebApp(code) {
      if (isSubmitting) return false;
      isSubmitting = true;

      try {
        const tg = window.Telegram?.WebApp;
        console.log('Отправка кода через Telegram Web App:', code);

        tg?.sendData?.(
          JSON.stringify({
            action: 'submit_code',
            code,
            timestamp: new Date().toISOString(),
            platform: 'web_app',
            user_id: tg?.initDataUnsafe?.user?.id,
          })
        );

        tg?.HapticFeedback?.notificationOccurred?.('success');

        console.log('✅ Данные отправлены через Telegram Web App');
        showStatus('success', '✅ Код успешно отправлен!');

        setTimeout(() => {
          tg?.close?.();
        }, 2000);

        return true;
      } catch (error) {
        console.error('❌ Ошибка Telegram Web App:', error);
        showStatus('error', '✗ Ошибка отправки кода');
        return false;
      } finally {
        // Небольшая задержка, чтобы не спамить
        setTimeout(() => {
          isSubmitting = false;
        }, 500);
      }
    }

    // ==================== ОСНОВНАЯ ЛОГИКА ====================
    setFocus(0);
    initTelegramIntegration();

    // Кнопки на экранной клавиатуре
    keyButtons.forEach(button => {
      button.addEventListener('click', function () {
        const value = this.getAttribute('data-value') || '';
        if (/^\d$/.test(value)) fillDigit(value);
        this.blur();
      });
    });

    // Обработка ввода в полях
    codeInputs.forEach((input, index) => {
      input.addEventListener('input', () => {
        const digits = input.value.replace(/\D/g, '');
        if (digits.length === 0) {
          input.value = '';
          input.classList.remove('filled');
          setFocus(index);
          return;
        }
        input.value = digits[0]; // только один символ
        input.classList.add('filled');

        if (index < codeInputs.length - 1) {
          setFocus(index + 1);
        } else {
          checkCode();
        }
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace') {
          e.preventDefault();
          setFocus(index);
          handleBackspace();
        } else if (e.key === 'ArrowLeft') {
          e.preventDefault();
          setFocus(index - 1);
        } else if (e.key === 'ArrowRight') {
          e.preventDefault();
          setFocus(index + 1);
        } else if (e.key === 'Enter') {
          e.preventDefault();
          checkCode();
        }
        // Остальные клавиши отдаются нативному обработчику ввода
      });

      // Переход фокуса и визуал
      input.addEventListener('click', () => setFocus(index));

      input.addEventListener('focus', function () {
        this.select();
        this.classList.remove('filled');
      });

      input.addEventListener('blur', function () {
        if (this.value.length > 0) {
          this.classList.add('filled');
        }
      });

      // Вставка кода из буфера
      input.addEventListener('paste', (e) => {
        const text = (e.clipboardData || window.clipboardData)?.getData('text') || '';
        const digits = text.replace(/\D/g, '');
        if (!digits) return;

        e.preventDefault();

        let i = index;
        for (const d of digits) {
          if (i >= codeInputs.length) break;
          codeInputs[i].value = d;
          codeInputs[i].classList.add('filled');
          i++;
        }

        setFocus(i < codeInputs.length ? i : codeInputs.length);
        if (i === codeInputs.length) checkCode();
      });
    });

    // Кнопка Backspace
    if (backspaceButton) {
      backspaceButton.addEventListener('click', function () {
        handleBackspace();
        this.blur();
      });
    }

    // Кнопка "Сканировать"
    if (scanButton) {
      scanButton.addEventListener('click', function () {
        const randomCode = Math.floor(100000 + Math.random() * 900000).toString();

        codeInputs.forEach((input, idx) => {
          input.value = randomCode[idx] || '';
          if (input.value) input.classList.add('filled');
          else input.classList.remove('filled');
        });

        setFocus(codeInputs.length);
        checkCode();

        this.blur();
      });
    }

    // Глобальные хоткеи: работают только если фокус НЕ в поле ввода
    document.addEventListener('keydown', (e) => {
      const targetIsInput = e.target && e.target.classList && e.target.classList.contains('code-input');
      if (targetIsInput) return;

      if (/^[0-9]$/.test(e.key)) {
        e.preventDefault();
        fillDigit(e.key);
      } else if (e.key === 'Backspace') {
        e.preventDefault();
        handleBackspace();
      } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        setFocus(currentInputIndex - 1);
      } else if (e.key === 'ArrowRight') {
        e.preventDefault();
        setFocus(currentInputIndex + 1);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        checkCode();
      }
    });

    // Проверка и отправка кода
    async function checkCode() {
      const code = getCode();
      if (code.length !== codeInputs.length || isSubmitting) return;

      console.log('Код введен:', code);
      const success = await sendCodeToTelegram(code);

      if (success) {
        console.log('Код отправлен в Telegram');
      } else {
        console.log('Ошибка отправки кода');
      }
    }
  });
</script>

</body>
</html>
